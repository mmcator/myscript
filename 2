--[[
    СКРИПТ ПОЛНОСТЬЮ ОЧИЩЕН.
    Оставлены ТОЛЬКО Aimbot и Aimbot FOV.
    Все остальные функции (Телепорты, Авто-Фарм, Misc, ESP и т.д.) УДАЛЕНЫ.
]]

-- ================================================================= --
-- 1. ИНИЦИАЛИЗАЦИЯ RAYFIELD И ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
-- ================================================================= --

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "SCP: RP Hub (Aimbot Only)",
    LoadingTitle = "Загрузка...",
    LoadingSubtitle = "by Novaz & Gemini",
    ConfigurationSaving = {
        Enabled = true,
        FileName = "SCPRP_Aimbot_Config"
    },
    ToggleKey = Enum.KeyCode.K -- Бинд на 'K'.
})

-- Глобальные переменные (только нужные для Aimbot)
local plr = game.Players.LocalPlayer
local mouse = plr:GetMouse()
local camera = game.Workspace.CurrentCamera
local userInput = game:GetService("UserInputService")
local ticket = 0
local timeHeld = 0
local isHolding = false
local RunService = game:GetService("RunService")
local fovCircle

pcall(function()
    fovCircle = Drawing.new("Circle")
    fovCircle.Visible = false
    fovCircle.Radius = 100
    fovCircle.Color = Color3.fromRGB(255, 255, 255)
    fovCircle.Thickness = 1
    fovCircle.Filled = false
    fovCircle.Transparency = 1
end)


-- ТАБЛИЦЫ "АЛЬЯНСОВ"
local foundationKeys = {
    "Security", "Scientific", "Mobile", "Internal", "Rapid", "Medical",
    "Intelligence", "Administrative"
}
local chaosKeys = {
    "Class - D", "Chaos Insurgency", "Class D"
}

-- ПЕРЕМЕННЫЕ ДЛЯ АИМБОТА
local aimbot_Enabled = false
local aimbot_TargetPart = "Head" -- По умолчанию целимся в голову
local aimbot_AimAtAllies = false 
local aimbot_ShowFov = false
local aimbot_FovSize = 100

-- ================================================================= --
-- 2. ЛОГИКА АИМБОТА
-- ================================================================= --

local function getTeamAlliance(teamName)
    if not teamName then return "Neutral" end
    for _, key in ipairs(foundationKeys) do
        if string.find(teamName, key, 1, true) then
            return "Foundation"
        end
    end
    for _, key in ipairs(chaosKeys) do
        if string.find(teamName, key, 1, true) then
            return "Chaos"
        end
    end
    return "Neutral"
end

local function isEnemy(targetPlayer)
    if not targetPlayer or targetPlayer == plr or not targetPlayer.Team or not plr.Team then
        return false
    end
    if aimbot_AimAtAllies == true then
        return true 
    end
    local myAlliance = getTeamAlliance(plr.Team.Name)
    local targetAlliance = getTeamAlliance(targetPlayer.Team.Name)
    if myAlliance == "Neutral" or targetAlliance == "Neutral" then
        return plr.Team.Name ~= targetPlayer.Team.Name
    end
    return myAlliance ~= targetAlliance
end

local function aimbot_getClosestPlayer()
    local closestPlayer = nil
    local closest_2D_Dist = aimbot_FovSize 

    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {plr.Character} 
    local crosshairPos = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)

    for _, target in pairs(game.Players:GetPlayers()) do
        if target ~= plr and isEnemy(target) and target.Character and target.Character:FindFirstChild("HumanoidRootPart") and target.Character:FindFirstChildOfClass('Humanoid') and target.Character:FindFirstChildOfClass('Humanoid').Health > 0 then
            
            local targetPart = target.Character:FindFirstChild(aimbot_TargetPart) or target.Character.HumanoidRootPart
            local screenPos, onScreen = camera:WorldToScreenPoint(targetPart.Position)
            
            if onScreen then
                local dist2D = (crosshairPos - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
                
                if dist2D <= aimbot_FovSize then
                    local origin = camera.CFrame.Position
                    local direction = (targetPart.Position - origin) 
                    local rayResult = workspace:Raycast(origin, direction, raycastParams)
                    
                    if (not rayResult or rayResult.Instance:IsDescendantOf(target.Character)) then
                        if dist2D < closest_2D_Dist then
                            closest_2D_Dist = dist2D
                            closestPlayer = target
                        end
                    end
                end
            end
        end
    end
    return closestPlayer
end

local function aimbot_aimAt(target)
    local targetPart = target.Character:FindFirstChild(aimbot_TargetPart)
    if not targetPart then
        targetPart = target.Character:FindFirstChild("HumanoidRootPart")
    end

    if target and targetPart then
        camera.CFrame = CFrame.new(camera.CFrame.Position, targetPart.Position)
    end
end

-- Holding MB2 Check (kalas)
function rightMouseButtonHeld()
    isHolding = true
end

function rightMouseButtonReleased()
    if not isHolding then
        return
    end
    isHolding = false
end

-- Обработка нажатий (только для RMB, 'K' теперь в Rayfield)
userInput.InputBegan:connect(function(input, gameProcessed)
    if gameProcessed then
        return
    end
    
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        ticket = ticket + 1
        local currentTicket = ticket

        if timeHeld > 0 then
            task.delay(timeHeld, function()
                if ticket == currentTicket then
                    rightMouseButtonHeld()
                end
            end)
        else
            rightMouseButtonHeld()
        end
    end
end)

userInput.InputEnded:connect(function(input, gameProcessed)
    if gameProcessed then
        return
    end

    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        ticket = ticket + 1
        rightMouseButtonReleased()
    end
end)


-- ================================================================= --
-- 3. СОЗДАНИЕ ОДНОЙ ВКЛАДКИ "MAIN"
-- ================================================================= --

local mainTab = Window:CreateTab("Main") -- <-- ЕДИНСТВЕННАЯ ВКЛАДКА

mainTab:CreateLabel("--- AIMBOT ---")
mainTab:CreateToggle({
   Name = "Enable Aimbot (Hold RMB)",
   Default = false,
   Callback = function(state)
        aimbot_Enabled = state
   end,
})
mainTab:CreateButton({
   Name = "Set Aimbot Target: Head",
   Callback = function() 
        aimbot_TargetPart = "Head"
        Rayfield:Notify("Aimbot", "Target set to Head", 5)
   end,
})
mainTab:CreateButton({
   Name = "Set Aimbot Target: Torso",
   Callback = function() 
        aimbot_TargetPart = "Torso"
        Rayfield:Notify("Aimbot", "Target set to Torso", 5)
   end,
})
mainTab:CreateToggle({
   Name = "Aim at Allies",
   Default = false,
   Callback = function(state)
        aimbot_AimAtAllies = state
   end,
})

mainTab:CreateLabel("--- AIMBOT FOV ---")
mainTab:CreateToggle({
   Name = "Show FOV Circle",
   Default = false,
   Callback = function(state)
        aimbot_ShowFov = state
   end,
})
mainTab:CreateInput({
   Name = "FOV Radius",
   PlaceholderText = "Default: 100",
   Callback = function(val)
        local newSize = tonumber(val)
        if newSize and newSize > 0 then
            aimbot_FovSize = newSize
        else
            aimbot_FovSize = 100
        end
   end,
})


-- ================================================================= --
-- 4. ГЛАВНЫЙ ЦИКЛ (RenderStepped)
-- ================================================================= --

game:GetService("RunService").RenderStepped:Connect(function()
    
    -- Проверка на наличие оружия в руках
    local equippedTool = plr.Character and plr.Character:FindFirstChildOfClass("Tool")
    
    -- ОБНОВЛЕНИЕ ДЛЯ КРУГА FOV
    pcall(function()
        if fovCircle then
            if aimbot_ShowFov then
                fovCircle.Radius = aimbot_FovSize 
                fovCircle.Position = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
                fovCircle.Visible = true
            else
                fovCircle.Visible = false
            end
        end
    end)
    
    -- ЛОГИКА АИМБОТА
    if aimbot_Enabled and isHolding and equippedTool then
        pcall(function()
            local target = aimbot_getClosestPlayer() 
            if target then
                aimbot_aimAt(target)
            end
        end)
    end
    
end)

-- Загрузка сохраненной конфигурации (если есть)
pcall(function()
    Rayfield:LoadConfiguration()
end)
