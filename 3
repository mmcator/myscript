--[[
    СКРИПТ АДАПТИРОВАН ДЛЯ "WAR TYCOON"
    ИЗМЕНЕНО: Аимбот активируется при наличии оружия в руках,
    а не при зажатии ПКМ.
    По умолчанию целимся в голову.
]]

-- ================================================================= --
-- 1. ИНИЦИАЛИЗАЦИЯ RAYFIELD И ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
-- ================================================================= --

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "War Tycoon Hub (Aimbot Only)",
    LoadingTitle = "Загрузка...",
    LoadingSubtitle = "by Novaz & Gemini",
    ConfigurationSaving = {
        Enabled = true,
        FileName = "WarTycoon_Aimbot_Config"
    },
    ToggleKey = Enum.KeyCode.K -- Бинд на 'K'.
})

-- Глобальные переменные (только нужные для Aimbot)
local plr = game.Players.LocalPlayer
local mouse = plr:GetMouse()
local camera = game.Workspace.CurrentCamera
local userInput = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local fovCircle

pcall(function()
    fovCircle = Drawing.new("Circle")
    fovCircle.Visible = false
    fovCircle.Radius = 100
    fovCircle.Color = Color3.fromRGB(255, 255, 255)
    fovCircle.Thickness = 1
    fovCircle.Filled = false
    fovCircle.Transparency = 1
end)

-- ПЕРЕМЕННЫЕ ДЛЯ АИМБОТА
local aimbot_Enabled = false
local aimbot_TargetPart = "Head" -- ЗАПРОС №2: По умолчанию целимся в голову
local aimbot_AimAtAllies = false 
local aimbot_ShowFov = false
local aimbot_FovSize = 100

-- ================================================================= --
-- 2. ЛОГИКА АИМБОТА
-- ================================================================= --

-- Простая функция проверки на врага
local function isEnemy(targetPlayer)
    if not targetPlayer or targetPlayer == plr or not targetPlayer.Team or not plr.Team then
        return false
    end
    if aimbot_AimAtAllies == true then
        return true 
    end
    return plr.Team ~= targetPlayer.Team
end

local function aimbot_getClosestPlayer()
    local closestPlayer = nil
    local closest_2D_Dist = aimbot_FovSize 

    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {plr.Character} 
    local crosshairPos = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)

    for _, target in pairs(game.Players:GetPlayers()) do
        if target ~= plr and isEnemy(target) and target.Character and target.Character:FindFirstChild("HumanoidRootPart") and target.Character:FindFirstChildOfClass('Humanoid') and target.Character:FindFirstChildOfClass('Humanoid').Health > 0 then
            
            local targetPart = target.Character:FindFirstChild(aimbot_TargetPart) or target.Character.HumanoidRootPart
            local screenPos, onScreen = camera:WorldToScreenPoint(targetPart.Position)
            
            if onScreen then
                local dist2D = (crosshairPos - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
                
                if dist2D <= aimbot_FovSize then
                    local origin = camera.CFrame.Position
                    local direction = (targetPart.Position - origin) 
                    local rayResult = workspace:Raycast(origin, direction, raycastParams)
                    
                    if (not rayResult or rayResult.Instance:IsDescendantOf(target.Character)) then
                        if dist2D < closest_2D_Dist then
                            closest_2D_Dist = dist2D
                            closestPlayer = target
                        end
                    end
                end
            end
        end
    end
    return closestPlayer
end

local function aimbot_aimAt(target)
    local targetPart = target.Character:FindFirstChild(aimbot_TargetPart)
    if not targetPart then
        targetPart = target.Character:FindFirstChild("HumanoidRootPart")
    end

    if target and targetPart then
        camera.CFrame = CFrame.new(camera.CFrame.Position, targetPart.Position)
    end
end

-- ================================================================= --
-- 3. СОЗДАНИЕ ОДНОЙ ВКЛАДКИ "MAIN"
-- ================================================================= --

local mainTab = Window:CreateTab("Main") -- <-- ЕДИНСТВЕННАЯ ВКЛАДКА

mainTab:CreateLabel("--- AIMBOT ---")
mainTab:CreateToggle({
   Name = "Enable Aimbot (when tool equipped)", -- ИЗМЕНЕНО: Обновлен текст
   Default = false,
   Callback = function(state)
        aimbot_Enabled = state
   end,
})
mainTab:CreateButton({
   Name = "Set Aimbot Target: Head",
   Callback = function() 
        aimbot_TargetPart = "Head"
        Rayfield:Notify("Aimbot", "Target set to Head", 5)
   end,
})
mainTab:CreateButton({
   Name = "Set Aimbot Target: Torso",
   Callback = function() 
        aimbot_TargetPart = "Torso"
        Rayfield:Notify("Aimbot", "Target set to Torso", 5)
   end,
})
mainTab:CreateToggle({
   Name = "Aim at Allies",
   Default = false,
   Callback = function(state)
        aimbot_AimAtAllies = state
   end,
})

mainTab:CreateLabel("--- AIMBOT FOV ---")
mainTab:CreateToggle({
   Name = "Show FOV Circle",
   Default = false,
   Callback = function(state)
        aimbot_ShowFov = state
   end,
})
mainTab:CreateInput({
   Name = "FOV Radius",
   PlaceholderText = "Default: 100",
   Callback = function(val)
        local newSize = tonumber(val)
        if newSize and newSize > 0 then
            aimbot_FovSize = newSize
        else
            aimbot_FovSize = 100
        end
   end,
})


-- ================================================================= --
-- 4. ГЛАВНЫЙ ЦИКЛ (RenderStepped)
-- ================================================================= --

game:GetService("RunService").RenderStepped:Connect(function()
    
    -- Проверка на наличие оружия в руках
    local equippedTool = plr.Character and plr.Character:FindFirstChildOfClass("Tool")
    
    -- ОБНОВЛЕНИЕ ДЛЯ КРУГА FOV
    pcall(function()
        if fovCircle then
            if aimbot_ShowFov then
                fovCircle.Radius = aimbot_FovSize 
                fovCircle.Position = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
                fovCircle.Visible = true
            else
                fovCircle.Visible = false
            end
        end
    end)
    
    -- ЛОГИКА АИМБОТА
    -- ИЗМЕНЕНО: Убрана проверка 'isHolding'
    if aimbot_Enabled and equippedTool then
        pcall(function()
            local target = aimbot_getClosestPlayer() 
            if target then
                aimbot_aimAt(target)
            end
        end)
    end
    
end)

-- Загрузка сохраненной конфигурации (если есть)
pcall(function()
    Rayfield:LoadConfiguration()
end)
